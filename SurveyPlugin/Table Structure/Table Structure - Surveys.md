# Surveys
### Original Survey
Survey forms are generated by the process `process_create_survey.php` through the file `form_create_new_survey.php` and are updated by the process `process_update_survey.php` through the file `view_form.php`
A typical survey is broken up in two parts, as survey details and survey questions.
The survey details are stored in a table called `form_list` with the following records

Table `form_list`:

| Field Name        | Description                                                                                                                                                                                                                                                                                                                                              |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| user_id           | Records user ID on survey creation                                                                                                                                                                                                                                                                                                                       |
| company_id        | Records user's company ID on creation. Will return 0 if user is not affiliated with a company (the user's that will return 0 will typically have the role administrator or cr_role)                                                                                                                                                                      |
| key_question      | This field is no longer being used                                                                                                                                                                                                                                                                                                                       |
| evidence_category | Used as a category for surveys when processed as a report. The ID of the category is stored in this field, refer to table `evidence_categories`                                                                                                                                                                                                          |
| quality_statement | This field is no longer being used.                                                                                                                                                                                                                                                                                                                      |
| form_code         | form_code gets generated on survey creation and should always be unique. It does have a max survey limit that is not handled, but chances are very low that it will be reached. Keep in mind that this field is always stored as a string, this is more of a fail-safe for future iteration in case we need to change the way form_code gets generated.  |
| url_edit          | Bit field that is used to check if the survey is using its `form_code` value (field has 0 stored) in the url query when the survey is form is being answered. Or `url_value` (field has 1 stored). Keep in mind it might be fine changing this field to a tiny int. PHP doesn't seem to work with bit fields too well and returns bit fields as strings. |
| url_value         | A string used to be query the url if url_edit is set to 1                                                                                                                                                                                                                                                                                                |
| title             | Value used to display the title of the survey                                                                                                                                                                                                                                                                                                            |
| description       | Value used to describe survey. This doesn't seem to be used often.                                                                                                                                                                                                                                                                                       |
| status            | Stored as a string. This field is used to set the availability of the survey, there are currently three statuses that a survey could be set to: 'Draft', 'Open', or 'Closed'                                                                                                                                                                             |
| date_created      | Date survey gets created                                                                                                                                                                                                                                                                                                                                 |
| date_updated      | Date survey is updated                                                                                                                                                                                                                                                                                                                                   |
| category          | Survey category is used for reports. Currently, as far as I know, the only relevant survey category is 'resident' as it can be used as a comparison option for a report if a variant with the category 'family' exists.                                                                                                                                  |
Survey questions have a unique ID that gets generated on creation, but note that this unique ID only has to be unique within its survey, so for all questions that share the same form_code will all have a Unique ID that does not match.
Survey questions are stored in the table `question_list`

Table `question_list`:

| Field Name          | Description                                                                                                                                                                                                                                                                                                                                                                                                            |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| q_uid               | wp_generate_uuid4() is used to generate the q_uid. There should be a check to make sure that q_uid is unique within all records that match on form_id, but the chance the function will create a duplicate record is very slim.                                                                                                                                                                                        |
| form_id             | form_id matches on form_code from the table `form_list`. I took the initiative to have slightly different names to identify which record comes from which table. Typically you'd use form_code to fetch records, and form_id is used to match question records.                                                                                                                                                        |
| question_order      | Each question on a survey has its own page and needs to be displayed in a specific order.                                                                                                                                                                                                                                                                                                                              |
| question_value      | Title of the question                                                                                                                                                                                                                                                                                                                                                                                                  |
| question_type       | Defines the type of question: 'description', 'paragraph', 'radio', 'checkbox', 'video_record', 'conditional_radio', 'star_rating'                                                                                                                                                                                                                                                                                      |
| options             | The field options defines additional attributes and options for some question types.                                                                                                                                                                                                                                                                                                                                   |
| key_question        | key_question field is specifically used for star_rating questions when processing a report. This field should at some point be incorporated in the options field if we ever get a chance to refactor the code                                                                                                                                                                                                          |
| evidence_category   | evidence_category field is no longer being used                                                                                                                                                                                                                                                                                                                                                                        |
| quality_statement   | quality_statement field is specifically used for star_rating questions when processing a report. This field should at some point be incorporated in the options field if we ever get a chance to refactor the code                                                                                                                                                                                                     |
| comment_labels      | comment_labels is used for the star_rating comments section when answering a survey as a question or statement when asking a user to leave a comment based on their rating selection. This field should also be incorporated in the options field if we ever get a chance to refactor the code, but keep in mind that the json structure for the options field for star_rating questions would need to be restructured |
| conditional         | This is a tiny int field used to check a question to redirect a user to condition_id_page value that matches that question_order                                                                                                                                                                                                                                                                                       |
| conditional_id_page | This value is used to redirect a user to a question where this value matches on a question_order if conditional field is 1                                                                                                                                                                                                                                                                                             |
| required            | This field is used to check if this question must be answered. required field should be renamed at some point if we ever get a chance to refactor the code so that it no longer uses a name that is too close to a reserved name 'require'                                                                                                                                                                             |
| core_question       | This is a tiny int field used to check if the current question is a core question. Core questions are precreated question created by a user that comes with its own predetermined question title, value, and options. Core questions also might have predetermined settings for its variant question. Note that the client might refer to a core question by a different name, "question bank"                         |
| core_question_id    | This int value is the id of a record in the table `core_questions`, this is used to determine the values for the fields of a question.                                                                                                                                                                                                                                                                                 |

### Variant Surveys

Variant surveys are essentially copies of the original survey where only question settings and options are changed. 
Just as the original surveys, variant surveys are broken up in two parts, the table `survey_variant_types` stores the variant details, and the table `survey_question_variants` stores the variant question details

Table `survey_variant_types`:

| Field Name          | Description                                                                                                                                                                                                                                                                                                                                              |
| ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| variant_type        | Variant type is the name of the variant visible only in the list of variants of a specific survey. See `view_survey_variant_types.php`                                                                                                                                                                                                                   |
| status              | Same as an original survey, the variant survey has 3 potential statuses: 'draft', 'open', or 'closed'                                                                                                                                                                                                                                                    |
| form_code           | This field is used to reference the original survey in the table `form_list` where the record matches on the field with the same name                                                                                                                                                                                                                    |
| variant_form_code   | This field is a string and is unique. It is also generated in the same way form_code is generated in an original survey                                                                                                                                                                                                                                  |
| url_edit            | Bit field that is used to check if the survey is using its `form_code` value (field has 0 stored) in the url query when the survey is form is being answered. Or `url_value` (field has 1 stored). Keep in mind it might be fine changing this field to a tiny int. PHP doesn't seem to work with bit fields too well and returns bit fields as strings. |
| url_value           | A string used to be query the url if url_edit is set to 1                                                                                                                                                                                                                                                                                                |
| variant_title       | Value used to display the title of the variant survey when a user is answering it. If this field is blank the title field from the table `form_list` should be used instead.                                                                                                                                                                             |
| variant_description | This field is only relevant to users who created or manage the variant survey, this does not seem to be used too often                                                                                                                                                                                                                                   |
| category            | Survey category is used for reports. Currently, as far as I know, the only relevant survey category is 'resident' as it can be used as a comparison option for a report if a variant with the category 'family' exists.                                                                                                                                  |

Variant  questions work similarly to the original survey questions, and are structured similarly too. Key things to note is that the variants do not generate its own q_uid. q_uid in the table `survey_question_variants` are always referencing the field q_uid as original survey question in the table `question_list`.

Table `survey_question_variants`:

| Field Name               | Description                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| q_uid                    | This 'q_uid' will match on a question with the same 'form_code' and 'q_uid' on the table `question_list`                                                                                                                                                                                                                                                                                                                                 |
| variant_id               | 'variant_id' matches on the 'id' field of a record in the table `survey_variant_types`                                                                                                                                                                                                                                                                                                                                                   |
| variant_code             | Redundant field that matches a unique record in the table `survey_variant_types`. This field would be the same record that matches 'variant_form_code' and 'variant_id' on id in the table `survey_variant_types`                                                                                                                                                                                                                        |
| form_code                | Redundant field that matches on 'form_code' in the table `survey_variant_types`. This field would be the same field in the table `survey_variant_types` that matches the 'id' field on 'variant_id'                                                                                                                                                                                                                                      |
| edit                     | 'edit' is a bit field. It is used to as a condition to either check editable settings for the variant question (1) or to ignore any editable settings (0). Like the other bit fields, it might be easier to work with tiny int instead.                                                                                                                                                                                                  |
| page_id                  | Redundant field. Same as the original question, the page_id works in the same way as the question_order. This field would be the exact match on 'question_order' in the table `question_list` where q_uid matches each other.                                                                                                                                                                                                            |
| default_type             | This field is in fact not redundant. We need it to confirm that the current settings for a variant question can be used in a survey. If the 'default_type' does not match the field 'question_type' in the table `question_list` where 'q_uid' and 'form_code' in `survey_question_variants` matches 'q_uid' and 'form_code' in `question_list` respectively, then the variant question is not valid and settings for it cannot be used. |
| setting_options          | 'setting_options' will in most cases be structured in a json object. This field is used to define most of the question's settings if a user decides to change alter any of them. Not all question types share the same type of elements in the json structure and some are unique to that specific question type                                                                                                                         |
| variant_core_question_id | As far as I can see, this field is no longer being used, or is no longer necessary.                                                                                                                                                                                                                                                                                                                                                      |
